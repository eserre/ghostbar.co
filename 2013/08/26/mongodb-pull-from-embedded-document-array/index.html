<!DOCTYPE HTML><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content=IE-edge><meta name=description content=""><meta name=viewport content="width=device-width, initial-scale=1"><!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/img/favicon-apple-57x57.png><link rel=apple-touch-icon sizes=72x72 href=/img/favicon-apple-72x72.png><link rel=apple-touch-icon sizes=114x114 href=/img/favicon-apple-114x114.png><link href="http://fonts.googleapis.com/css?family=Source+Code+Pro:300|Lato:300,300italic" rel=stylesheet type=text/css><link rel=stylesheet href=/css/main.ee39.css><script src=/js/head-scripts.d41d.js></script><title>MongoDB: $pull from an embedded document array &mdash; ghostbar</title></head><body><header id=header class=container><div class=row><div id=logo class=twocol><a href="/"><img src=/img/logo-128x128.b4c1.png></a></div><!-- end of #logo --><div id=title class=sixcol><a href="/"><h1>ghostbar</h1></a><p id=tagline>Random thoughts on technology</p></div><!-- end of #title --><div id=menu class=twocol><ul><li><a href=/archive.html>Archive</a></li><li><a href=https://twitter.com/ghostbar>Twitter</a></li><li><a href=https://github.com/ghostbar>GitHub</a></li><li><a href="https://pgp.mit.edu/pks/lookup?search=0x13EC43EEB9AC8C43&op=vindex&fingerprint=on">GPG Key</a></li></ul></div><!-- end of #menu --></div><!-- end of .row --><div class=clearfix></div></header><!-- end of #header.container --><div id=post class=container><div class="row container"><article class="twelvecol post"><header><h1>MongoDB: $pull from an embedded document array</h1><div class=date>August 26, 2013</div></header><div class=content><p>TL;DR:</p><div class=highlight><pre><code class=js>    <span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span><span class=nx>_id</span><span class=o>:</span> <span class=s1>&#39;x&#39;</span><span class=p>},</span> <span class=p>{</span><span class=nx>$pull</span><span class=o>:</span> <span class=p>{</span><span class=nx>embedded_doc</span><span class=o>:</span> <span class=p>{</span><span class=nx>_id</span><span class=o>:</span> <span class=s1>&#39;y&#39;</span><span class=p>}}})</span>
</code></pre></div><p><small>Queries are wrote for the <code>mongo</code> shell</small></p><h2>Dot based access</h2><p>If you have been using <a href=http://mongodb.org>MongoDB</a> for some time, then there are big chances that you will know the "dot-based access" on the <code>find</code> queries. This is the easier way to write those queries and will probably want to keep using that. Like:</p><div class=highlight><pre><code class=js>    <span class=nx>db</span><span class=p>.</span><span class=nx>collection</span><span class=p>.</span><span class=nx>find</span><span class=p>({</span><span class=nx>_id</span><span class=o>:</span> <span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=s1>&#39;embedded_doc._id&#39;</span><span class=o>:</span> <span class=s1>&#39;y&#39;</span><span class=p>})</span>
</code></pre></div><p>The thing is that does not work with everything, like: Arrays of embedded documents!</p><h2>Little example schema</h2><p>Let's suppose the following little schema (written for <a href=http://mongoosejs.com>Mongoose</a>):</p><div class=highlight><pre><code class=js>    <span class=nx>A</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Schema</span><span class=p>({</span>
      <span class=nx>w</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
      <span class=nx>x</span><span class=o>:</span> <span class=nb>String</span>
    <span class=p>});</span>

    <span class=nx>Document</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Schema</span><span class=p>({</span>
      <span class=nx>embedded_doc</span><span class=o>:</span> <span class=p>[</span><span class=nx>A</span><span class=p>]</span>
    <span class=p>});</span>
</code></pre></div><p>The collection of <code>Document</code> is called <code>documents</code>.</p><h2>Updating arrays</h2><p>If the arrays are not embedded documents I can actually just use a regular <code>update</code> like with any other field combined with a <code>$set</code> and change all the array like:</p><div class=highlight><pre><code class=js>    <span class=nx>db</span><span class=p>.</span><span class=nx>documents</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span><span class=nx>_id</span><span class=o>:</span> <span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=p>{</span><span class=nx>$set</span><span class=o>:</span> <span class=p>{</span><span class=nx>array</span><span class=o>:</span> <span class=p>[</span>
      <span class=p>{</span><span class=nx>a</span><span class=o>:</span> <span class=mi>1</span><span class=p>},</span> 
      <span class=p>{</span><span class=nx>a</span><span class=o>:</span> <span class=mi>2</span><span class=p>},</span> 
      <span class=p>{</span><span class=nx>a</span><span class=o>:</span> <span class=mi>3</span><span class=p>}</span>
    <span class=p>]}}})</span>
</code></pre></div><p>And using conveniently <code>$pull</code> and <code>$addToSet</code>. But when it comes to embedded documents the history is very different. You can't make a simple <code>$set</code> because it will give you an error related to <code>ModId</code> which you can't change. So you really need to use <code>$push</code>, <code>$addToSet</code>, <code>$pull</code> and it's friends.</p><p>So all those you can do it as in the manual, but what if you want to make a <code>$pull</code> over an array of objects and <code>w</code> and <code>x</code> are not unique? Well, that's why you probably made them an embedded document! Then you have the <code>_id</code> and you try to use the dot notation like:</p><div class=highlight><pre><code class=js>    <span class=nx>db</span><span class=p>.</span><span class=nx>documents</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span><span class=nx>_id</span><span class=o>:</span> <span class=s1>&#39;x&#39;</span><span class=p>},</span> <span class=p>{</span><span class=nx>$pull</span><span class=o>:</span> <span class=p>{</span><span class=s2>&quot;embedded_doc._id&quot;</span><span class=o>:</span> <span class=s1>&#39;y&#39;</span><span class=p>})</span>
</code></pre></div><p>And it looks good, except that it wont work. You have to use the complete syntax like:</p><div class=highlight><pre><code class=js>    <span class=nx>db</span><span class=p>.</span><span class=nx>documents</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span><span class=nx>_id</span><span class=o>:</span> <span class=s1>&#39;x&#39;</span><span class=p>},</span> <span class=p>{</span><span class=nx>$pull</span><span class=o>:</span> <span class=p>{</span><span class=nx>embedded_doc</span><span class=o>:</span> <span class=p>{</span><span class=nx>_id</span><span class=o>:</span> <span class=s1>&#39;y&#39;</span><span class=p>}}})</span>
</code></pre></div></div><footer><small><em>You should follow me on twitter <a href=http://twitter.com/ghostbar>here</a></em>.</small></footer></article></div><!-- end .row --></div><!-- end .container --><script src=/js/script.d16b.js></script><!-- Google Analytics: change UA-XXXXX-X to be your site's ID. --><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
  function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
  e=o.createElement(i);r=o.getElementsByTagName(i)[0];
  e.src='//www.google-analytics.com/analytics.js';
  r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
  ga('create','UA-1022716-2');ga('send','pageview');</script><div class=clearfix></div><footer id=footer class=container><div class=row><div class="twelvecol last"><small>Â© 2012-2014, Jose Luis Rivas. Built with <a href=http://jekyllrb.com>Jekyll</a> by <a href=http://joseluisrivas.net>Jose Luis Rivas</a>.</small> <small class=pull-right><a href=/feed.xml>RSS</a></small></div><!-- end of .twelvecol --></div><!-- end of .row --></footer></body></html>